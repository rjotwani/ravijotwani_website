{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _slicedToArray2 = require('babel-runtime/helpers/slicedToArray');\n\nvar _slicedToArray3 = _interopRequireDefault(_slicedToArray2);\n\nvar _regenerator = require('babel-runtime/regenerator');\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require('babel-runtime/helpers/inherits');\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nvar _react = require('react');\n\nvar _react2 = _interopRequireDefault(_react);\n\nvar _propTypes = require('prop-types');\n\nvar _propTypes2 = _interopRequireDefault(_propTypes);\n\nvar _propTypes3 = require('../shared/propTypes');\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n} // Render disproportion above which font will be considered broken and fallback will be used\n\n\nvar BROKEN_FONT_ALARM_THRESHOLD = 0.1;\n\nvar TextLayerItem = function (_PureComponent) {\n  (0, _inherits3.default)(TextLayerItem, _PureComponent);\n\n  function TextLayerItem() {\n    var _ref;\n\n    var _temp, _this, _ret;\n\n    (0, _classCallCheck3.default)(this, TextLayerItem);\n\n    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    return _ret = (_temp = (_this = (0, _possibleConstructorReturn3.default)(this, (_ref = TextLayerItem.__proto__ || (0, _getPrototypeOf2.default)(TextLayerItem)).call.apply(_ref, [this].concat(args))), _this), _this.state = {\n      transform: null\n    }, _this.getElementWidth = function (element) {\n      var _this2 = _this,\n          sideways = _this2.sideways;\n      return element.getBoundingClientRect()[sideways ? 'height' : 'width'];\n    }, _temp), (0, _possibleConstructorReturn3.default)(_this, _ret);\n  }\n\n  (0, _createClass3.default)(TextLayerItem, [{\n    key: 'componentDidMount',\n    value: function componentDidMount() {\n      this.alignTextItem();\n    }\n  }, {\n    key: 'getFontData',\n    value: function () {\n      var _ref2 = (0, _asyncToGenerator3.default)(\n      /*#__PURE__*/\n      _regenerator2.default.mark(function _callee(fontFamily) {\n        var page, font;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                page = this.context.page;\n                _context.next = 3;\n                return page.commonObjs.ensureObj(fontFamily);\n\n              case 3:\n                font = _context.sent;\n                return _context.abrupt('return', font.data);\n\n              case 5:\n              case 'end':\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function getFontData(_x) {\n        return _ref2.apply(this, arguments);\n      }\n\n      return getFontData;\n    }()\n  }, {\n    key: 'alignTextItem',\n    value: function () {\n      var _ref3 = (0, _asyncToGenerator3.default)(\n      /*#__PURE__*/\n      _regenerator2.default.mark(function _callee2() {\n        var element, scale, _props, fontName, width, targetWidth, fontData, actualWidth, widthDisproportion, repairsNeeded, fallbackFontName, ascent;\n\n        return _regenerator2.default.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (this.item) {\n                  _context2.next = 2;\n                  break;\n                }\n\n                return _context2.abrupt('return');\n\n              case 2:\n                element = this.item;\n                element.style.transform = '';\n                scale = this.context.scale;\n                _props = this.props, fontName = _props.fontName, width = _props.width;\n                targetWidth = width * scale;\n                _context2.next = 9;\n                return this.getFontData(fontName);\n\n              case 9:\n                fontData = _context2.sent;\n                actualWidth = this.getElementWidth(element);\n                widthDisproportion = Math.abs(targetWidth / actualWidth - 1);\n                repairsNeeded = widthDisproportion > BROKEN_FONT_ALARM_THRESHOLD;\n\n                if (repairsNeeded) {\n                  fallbackFontName = fontData ? fontData.fallbackName : 'sans-serif';\n                  element.style.fontFamily = fallbackFontName;\n                  actualWidth = this.getElementWidth(element);\n                }\n\n                ascent = fontData ? fontData.ascent : 1;\n                this.setState({\n                  transform: 'scaleX(' + targetWidth / actualWidth + ') translateY(' + (1 - ascent) * 100 + '%)'\n                });\n\n              case 16:\n              case 'end':\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function alignTextItem() {\n        return _ref3.apply(this, arguments);\n      }\n\n      return alignTextItem;\n    }()\n  }, {\n    key: 'render',\n    value: function render() {\n      var _this3 = this;\n\n      var fontSize = this.fontSize,\n          top = this.top,\n          left = this.left;\n      var scale = this.context.scale;\n      var _props2 = this.props,\n          fontName = _props2.fontName,\n          text = _props2.str;\n      var transform = this.state.transform;\n      return _react2.default.createElement('div', {\n        style: {\n          height: '1em',\n          fontFamily: fontName,\n          fontSize: fontSize * scale + 'px',\n          position: 'absolute',\n          top: top * scale + 'px',\n          left: left * scale + 'px',\n          transformOrigin: 'left bottom',\n          whiteSpace: 'pre',\n          pointerEvents: 'all',\n          transform: transform\n        },\n        ref: function ref(_ref4) {\n          _this3.item = _ref4;\n        }\n      }, this.context.customTextRenderer ? this.context.customTextRenderer(this.props) : text);\n    }\n  }, {\n    key: 'unrotatedViewport',\n    get: function get() {\n      var _context3 = this.context,\n          page = _context3.page,\n          scale = _context3.scale;\n      return page.getViewport(scale);\n    }\n    /**\n     * It might happen that the page is rotated by default. In such cases, we shouldn't rotate\n     * text content.\n     */\n\n  }, {\n    key: 'rotate',\n    get: function get() {\n      var _context4 = this.context,\n          page = _context4.page,\n          rotate = _context4.rotate;\n      return rotate - page.rotate;\n    }\n  }, {\n    key: 'sideways',\n    get: function get() {\n      var rotate = this.rotate;\n      return rotate % 180 !== 0;\n    }\n  }, {\n    key: 'defaultSideways',\n    get: function get() {\n      var rotation = this.unrotatedViewport.rotation;\n      return rotation % 180 !== 0;\n    }\n  }, {\n    key: 'fontSize',\n    get: function get() {\n      var transform = this.props.transform;\n      var defaultSideways = this.defaultSideways;\n\n      var _transform = (0, _slicedToArray3.default)(transform, 2),\n          fontHeightPx = _transform[0],\n          fontWidthPx = _transform[1];\n\n      return defaultSideways ? fontWidthPx : fontHeightPx;\n    }\n  }, {\n    key: 'top',\n    get: function get() {\n      var transform = this.props.transform;\n      var viewport = this.unrotatedViewport,\n          defaultSideways = this.defaultSideways;\n\n      var _transform2 = (0, _slicedToArray3.default)(transform, 6),\n\n      /* fontHeightPx */\n      offsetX = _transform2[2],\n          offsetY = _transform2[3],\n          x = _transform2[4],\n          y = _transform2[5];\n\n      var _viewport$viewBox = (0, _slicedToArray3.default)(viewport.viewBox, 4),\n\n      /* xMin */\n      yMin = _viewport$viewBox[1],\n\n      /* xMax */\n      yMax = _viewport$viewBox[3];\n\n      return defaultSideways ? x + offsetX + yMin : yMax - (y + offsetY);\n    }\n  }, {\n    key: 'left',\n    get: function get() {\n      var transform = this.props.transform;\n      var viewport = this.unrotatedViewport,\n          defaultSideways = this.defaultSideways;\n\n      var _transform3 = (0, _slicedToArray3.default)(transform, 6),\n\n      /* fontHeightPx */\n\n      /* fontWidthPx */\n\n      /* offsetX */\n      x = _transform3[4],\n          y = _transform3[5];\n\n      var _viewport$viewBox2 = (0, _slicedToArray3.default)(viewport.viewBox, 1),\n          xMin = _viewport$viewBox2[0];\n\n      return defaultSideways ? y - xMin : x - xMin;\n    }\n  }]);\n  return TextLayerItem;\n}(_react.PureComponent);\n\nexports.default = TextLayerItem;\nTextLayerItem.contextTypes = {\n  customTextRenderer: _propTypes2.default.func,\n  page: _propTypes3.isPage.isRequired,\n  rotate: _propTypes3.isRotate,\n  scale: _propTypes2.default.number\n};\nTextLayerItem.propTypes = {\n  fontName: _propTypes2.default.string.isRequired,\n  itemIndex: _propTypes2.default.number.isRequired,\n  // eslint-disable-line react/no-unused-prop-types\n  str: _propTypes2.default.string.isRequired,\n  transform: _propTypes2.default.arrayOf(_propTypes2.default.number).isRequired,\n  width: _propTypes2.default.number.isRequired\n};","map":null,"metadata":{},"sourceType":"script"}